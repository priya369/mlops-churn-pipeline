steps:
  # Stage 1: Install and test
  - name: 'python:3.9'
    id: 'install-deps'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“¦ Installing dependencies..."
        pip install -r requirements.txt
        echo "âœ… Done"

  # Stage 2: Validate components
  - name: 'python:3.9'
    id: 'validate'
    waitFor: ['install-deps']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ” Validating components..."
        ls -la components/
        echo "âœ… Components validated"

  # Stage 3: Compile pipeline
  - name: 'python:3.9'
    id: 'compile'
    waitFor: ['validate']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“¦ Compiling pipeline..."
        pip install kfp google-cloud-aiplatform
        cd pipelines
        python house_price_pipeline.py
        ls -lh house_price_pipeline.json
        echo "âœ… Compiled"

  # Stage 4: Submit to Vertex AI
  - name: 'python:3.9'
    id: 'submit'
    waitFor: ['compile']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Submitting pipeline to Vertex AI..."
        pip install google-cloud-aiplatform
        python3 << 'PYEOF'
        from google.cloud import aiplatform
        import os
        
        PROJECT_ID = "data-oasis-472909-u4"
        REGION = "us-central1"
        BUCKET = "data-oasis-472909-u4-mlops"
        
        aiplatform.init(project=PROJECT_ID, location=REGION)
        
        job = aiplatform.PipelineJob(
            display_name=f"house-price-cicd-{os.environ['SHORT_SHA']}",
            template_path="pipelines/house_price_pipeline.json",
            pipeline_root=f"gs://{BUCKET}/pipeline_root",
            enable_caching=False
        )
        
        job.submit()
        print(f"âœ… Pipeline submitted!")
        print(f"View: https://console.cloud.google.com/vertex-ai/locations/{REGION}/pipelines/runs?project={PROJECT_ID}")
        PYEOF

  # Stage 5: Notify
  - name: 'bash'
    id: 'notify'
    waitFor: ['submit']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=============================="
        echo "âœ… CI/CD Pipeline Complete!"
        echo "=============================="
        echo "Build: ${BUILD_ID}"
        echo "Commit: ${SHORT_SHA}"
        echo "Project: ${PROJECT_ID}"
        echo "=============================="

substitutions:
  _REGION: 'us-central1'
  _BUCKET_NAME: '${PROJECT_ID}-bucket'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'

timeout: '1800s'
