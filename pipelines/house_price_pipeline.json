{
  "components": {
    "comp-deploy-model": {
      "executorLabel": "exec-deploy-model",
      "inputDefinitions": {
        "artifacts": {
          "approval": {
            "artifactType": {
              "schemaTitle": "system.Artifact",
              "schemaVersion": "0.0.1"
            }
          },
          "model": {
            "artifactType": {
              "schemaTitle": "system.Model",
              "schemaVersion": "0.0.1"
            }
          }
        },
        "parameters": {
          "endpoint_name": {
            "parameterType": "STRING"
          },
          "model_name": {
            "parameterType": "STRING"
          },
          "project_id": {
            "parameterType": "STRING"
          },
          "region": {
            "parameterType": "STRING"
          }
        }
      },
      "outputDefinitions": {
        "artifacts": {
          "deployment_info": {
            "artifactType": {
              "schemaTitle": "system.Artifact",
              "schemaVersion": "0.0.1"
            }
          }
        }
      }
    },
    "comp-evaluate-model": {
      "executorLabel": "exec-evaluate-model",
      "inputDefinitions": {
        "artifacts": {
          "model": {
            "artifactType": {
              "schemaTitle": "system.Model",
              "schemaVersion": "0.0.1"
            }
          },
          "test_data": {
            "artifactType": {
              "schemaTitle": "system.Dataset",
              "schemaVersion": "0.0.1"
            }
          }
        }
      },
      "outputDefinitions": {
        "artifacts": {
          "approval": {
            "artifactType": {
              "schemaTitle": "system.Artifact",
              "schemaVersion": "0.0.1"
            }
          },
          "eval_metrics": {
            "artifactType": {
              "schemaTitle": "system.Metrics",
              "schemaVersion": "0.0.1"
            }
          }
        }
      }
    },
    "comp-ingest-data": {
      "executorLabel": "exec-ingest-data",
      "inputDefinitions": {
        "parameters": {
          "project_id": {
            "parameterType": "STRING"
          }
        }
      },
      "outputDefinitions": {
        "artifacts": {
          "output_data": {
            "artifactType": {
              "schemaTitle": "system.Dataset",
              "schemaVersion": "0.0.1"
            }
          }
        }
      }
    },
    "comp-prepare-features": {
      "executorLabel": "exec-prepare-features",
      "inputDefinitions": {
        "artifacts": {
          "input_data": {
            "artifactType": {
              "schemaTitle": "system.Dataset",
              "schemaVersion": "0.0.1"
            }
          }
        }
      },
      "outputDefinitions": {
        "artifacts": {
          "test_data": {
            "artifactType": {
              "schemaTitle": "system.Dataset",
              "schemaVersion": "0.0.1"
            }
          },
          "train_data": {
            "artifactType": {
              "schemaTitle": "system.Dataset",
              "schemaVersion": "0.0.1"
            }
          }
        }
      }
    },
    "comp-train-model": {
      "executorLabel": "exec-train-model",
      "inputDefinitions": {
        "artifacts": {
          "train_data": {
            "artifactType": {
              "schemaTitle": "system.Dataset",
              "schemaVersion": "0.0.1"
            }
          }
        }
      },
      "outputDefinitions": {
        "artifacts": {
          "metrics": {
            "artifactType": {
              "schemaTitle": "system.Metrics",
              "schemaVersion": "0.0.1"
            }
          },
          "model_output": {
            "artifactType": {
              "schemaTitle": "system.Model",
              "schemaVersion": "0.0.1"
            }
          }
        }
      }
    }
  },
  "deploymentSpec": {
    "executors": {
      "exec-deploy-model": {
        "container": {
          "args": [
            "--executor_input",
            "{{$}}",
            "--function_to_execute",
            "deploy_model"
          ],
          "command": [
            "sh",
            "-c",
            "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'google-cloud-aiplatform'  &&  python3 -m pip install --quiet --no-warn-script-location 'kfp==2.14.6' '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"$0\" \"$@\"\n",
            "sh",
            "-ec",
            "program_path=$(mktemp -d)\n\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\n_KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
            "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import *\n\ndef deploy_model(\n    model: Input[Model],\n    approval: Input[Artifact],\n    project_id: str,\n    region: str,\n    model_name: str,\n    endpoint_name: str,\n    deployment_info: Output[Artifact]\n):\n    \"\"\"Register and deploy model to Vertex AI\"\"\"\n    from google.cloud import aiplatform\n\n    # Check approval\n    with open(approval.path, 'r') as f:\n        approved = f.read().strip()\n\n    if approved != \"true\":\n        print(\"\u274c Model not approved\")\n        with open(deployment_info.path, 'w') as f:\n            f.write(\"status: rejected\")\n        return\n\n    # Initialize Vertex AI\n    aiplatform.init(project=project_id, location=region)\n\n    print(\"\ud83d\udce6 Uploading model to Vertex AI Model Registry...\")\n    uploaded_model = aiplatform.Model.upload(\n        display_name=model_name,\n        artifact_uri=model.uri,\n        serving_container_image_uri=\"us-docker.pkg.dev/vertex-ai/prediction/sklearn-cpu.1-0:latest\"\n    )\n\n    print(f\"\u2705 Model registered: {uploaded_model.resource_name}\")\n\n    # Get or create endpoint\n    endpoints = aiplatform.Endpoint.list(filter=f'display_name=\"{endpoint_name}\"')\n\n    if endpoints:\n        endpoint = endpoints[0]\n        print(f\"\ud83d\udccd Using existing endpoint: {endpoint.display_name}\")\n    else:\n        endpoint = aiplatform.Endpoint.create(display_name=endpoint_name)\n        print(f\"\ud83d\udccd Created new endpoint: {endpoint.display_name}\")\n\n    # Deploy\n    print(\"\ud83d\ude80 Deploying model...\")\n    uploaded_model.deploy(\n        endpoint=endpoint,\n        machine_type=\"n1-standard-2\",\n        min_replica_count=1,\n        max_replica_count=1,\n        traffic_percentage=100\n    )\n\n    # Save info\n    info = f\"status: deployed\\nmodel: {uploaded_model.resource_name}\\nendpoint: {endpoint.resource_name}\"\n    with open(deployment_info.path, 'w') as f:\n        f.write(info)\n\n    print(f\"\u2705 Deployed to: {endpoint.resource_name}\")\n\n"
          ],
          "image": "python:3.9"
        }
      },
      "exec-evaluate-model": {
        "container": {
          "args": [
            "--executor_input",
            "{{$}}",
            "--function_to_execute",
            "evaluate_model"
          ],
          "command": [
            "sh",
            "-c",
            "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'pandas' 'scikit-learn' 'joblib'  &&  python3 -m pip install --quiet --no-warn-script-location 'kfp==2.14.6' '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"$0\" \"$@\"\n",
            "sh",
            "-ec",
            "program_path=$(mktemp -d)\n\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\n_KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
            "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import *\n\ndef evaluate_model(\n    model: Input[Model],\n    test_data: Input[Dataset],\n    eval_metrics: Output[Metrics],\n    approval: Output[Artifact]\n):\n    \"\"\"Evaluate model performance\"\"\"\n    import pandas as pd\n    import joblib\n    from sklearn.metrics import mean_squared_error, r2_score, mean_absolute_error\n    import math\n\n    # Load model and data\n    trained_model = joblib.load(model.path + \"/model.pkl\")\n    df = pd.read_csv(test_data.path)\n\n    X_test = df.drop('MedHouseVal', axis=1)\n    y_test = df['MedHouseVal']\n\n    # Predictions\n    y_pred = trained_model.predict(X_test)\n\n    # Metrics\n    mse = mean_squared_error(y_test, y_pred)\n    rmse = math.sqrt(mse)\n    mae = mean_absolute_error(y_test, y_pred)\n    r2 = r2_score(y_test, y_pred)\n\n    # Log metrics\n    eval_metrics.log_metric(\"mse\", float(mse))\n    eval_metrics.log_metric(\"rmse\", float(rmse))\n    eval_metrics.log_metric(\"mae\", float(mae))\n    eval_metrics.log_metric(\"r2_score\", float(r2))\n\n    print(f\"\ud83d\udcca RMSE: {rmse:.4f}\")\n    print(f\"\ud83d\udcca MAE: {mae:.4f}\")\n    print(f\"\ud83d\udcca R\u00b2: {r2:.4f}\")\n\n    # Approval logic (R\u00b2 > 0.7)\n    approved = \"true\" if r2 > 0.7 else \"false\"\n\n    with open(approval.path, 'w') as f:\n        f.write(approved)\n\n    status = \"\u2705 APPROVED\" if approved == \"true\" else \"\u274c REJECTED\"\n    print(f\"{status} (R\u00b2 threshold: 0.7)\")\n\n"
          ],
          "image": "python:3.9"
        }
      },
      "exec-ingest-data": {
        "container": {
          "args": [
            "--executor_input",
            "{{$}}",
            "--function_to_execute",
            "ingest_data"
          ],
          "command": [
            "sh",
            "-c",
            "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'google-cloud-bigquery' 'pandas' 'pyarrow' 'db-dtypes'  &&  python3 -m pip install --quiet --no-warn-script-location 'kfp==2.14.6' '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"$0\" \"$@\"\n",
            "sh",
            "-ec",
            "program_path=$(mktemp -d)\n\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\n_KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
            "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import *\n\ndef ingest_data(\n    project_id: str,\n    output_data: Output[Dataset]\n):\n    \"\"\"Fetch housing data from BigQuery\"\"\"\n    from google.cloud import bigquery\n    import pandas as pd\n\n    client = bigquery.Client(project=project_id)\n\n    query = f\"\"\"\n    SELECT * FROM `{project_id}.housing_data.houses`\n    \"\"\"\n\n    df = client.query(query).to_dataframe()\n    df.to_csv(output_data.path, index=False)\n\n    print(f\"\u2705 Loaded {len(df)} rows\")\n    print(f\"Features: {list(df.columns)}\")\n\n"
          ],
          "image": "python:3.9"
        }
      },
      "exec-prepare-features": {
        "container": {
          "args": [
            "--executor_input",
            "{{$}}",
            "--function_to_execute",
            "prepare_features"
          ],
          "command": [
            "sh",
            "-c",
            "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'pandas' 'scikit-learn'  &&  python3 -m pip install --quiet --no-warn-script-location 'kfp==2.14.6' '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"$0\" \"$@\"\n",
            "sh",
            "-ec",
            "program_path=$(mktemp -d)\n\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\n_KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
            "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import *\n\ndef prepare_features(\n    input_data: Input[Dataset],\n    train_data: Output[Dataset],\n    test_data: Output[Dataset]\n):\n    \"\"\"Split and prepare data\"\"\"\n    import pandas as pd\n    from sklearn.model_selection import train_test_split\n\n    df = pd.read_csv(input_data.path)\n\n    # Remove ID column\n    df = df.drop('house_id', axis=1, errors='ignore')\n\n    # Split features and target\n    X = df.drop('MedHouseVal', axis=1)\n    y = df['MedHouseVal']\n\n    # Train-test split\n    X_train, X_test, y_train, y_test = train_test_split(\n        X, y, test_size=0.2, random_state=42\n    )\n\n    # Save\n    train_df = X_train.copy()\n    train_df['MedHouseVal'] = y_train\n    test_df = X_test.copy()\n    test_df['MedHouseVal'] = y_test\n\n    train_df.to_csv(train_data.path, index=False)\n    test_df.to_csv(test_data.path, index=False)\n\n    print(f\"\u2705 Train: {train_df.shape}, Test: {test_df.shape}\")\n\n"
          ],
          "image": "python:3.9"
        }
      },
      "exec-train-model": {
        "container": {
          "args": [
            "--executor_input",
            "{{$}}",
            "--function_to_execute",
            "train_model"
          ],
          "command": [
            "sh",
            "-c",
            "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet --no-warn-script-location 'pandas' 'scikit-learn' 'joblib'  &&  python3 -m pip install --quiet --no-warn-script-location 'kfp==2.14.6' '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"$0\" \"$@\"\n",
            "sh",
            "-ec",
            "program_path=$(mktemp -d)\n\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\n_KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
            "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import *\n\ndef train_model(\n    train_data: Input[Dataset],\n    model_output: Output[Model],\n    metrics: Output[Metrics]\n):\n    \"\"\"Train Random Forest model\"\"\"\n    import pandas as pd\n    from sklearn.ensemble import RandomForestRegressor\n    import joblib\n\n    # Load data\n    df = pd.read_csv(train_data.path)\n    X_train = df.drop('MedHouseVal', axis=1)\n    y_train = df['MedHouseVal']\n\n    # Train model\n    print(\"\ud83d\udd27 Training Random Forest...\")\n    model = RandomForestRegressor(\n        n_estimators=100,\n        max_depth=10,\n        random_state=42,\n        n_jobs=-1\n    )\n    model.fit(X_train, y_train)\n\n    # Save model\n    joblib.dump(model, model_output.path + \"/model.pkl\")\n\n    # Log metrics\n    metrics.log_metric(\"n_estimators\", 100)\n    metrics.log_metric(\"max_depth\", 10)\n    metrics.log_metric(\"training_samples\", len(X_train))\n\n    print(\"\u2705 Model trained successfully\")\n\n"
          ],
          "image": "python:3.9"
        }
      }
    }
  },
  "pipelineInfo": {
    "description": "End-to-end MLOps pipeline for house price prediction",
    "name": "house-price-mlops-pipeline"
  },
  "root": {
    "dag": {
      "tasks": {
        "deploy-model": {
          "cachingOptions": {
            "enableCache": true
          },
          "componentRef": {
            "name": "comp-deploy-model"
          },
          "dependentTasks": [
            "evaluate-model",
            "train-model"
          ],
          "inputs": {
            "artifacts": {
              "approval": {
                "taskOutputArtifact": {
                  "outputArtifactKey": "approval",
                  "producerTask": "evaluate-model"
                }
              },
              "model": {
                "taskOutputArtifact": {
                  "outputArtifactKey": "model_output",
                  "producerTask": "train-model"
                }
              }
            },
            "parameters": {
              "endpoint_name": {
                "componentInputParameter": "endpoint_name"
              },
              "model_name": {
                "componentInputParameter": "model_name"
              },
              "project_id": {
                "componentInputParameter": "project_id"
              },
              "region": {
                "componentInputParameter": "region"
              }
            }
          },
          "taskInfo": {
            "name": "deploy-model"
          }
        },
        "evaluate-model": {
          "cachingOptions": {
            "enableCache": true
          },
          "componentRef": {
            "name": "comp-evaluate-model"
          },
          "dependentTasks": [
            "prepare-features",
            "train-model"
          ],
          "inputs": {
            "artifacts": {
              "model": {
                "taskOutputArtifact": {
                  "outputArtifactKey": "model_output",
                  "producerTask": "train-model"
                }
              },
              "test_data": {
                "taskOutputArtifact": {
                  "outputArtifactKey": "test_data",
                  "producerTask": "prepare-features"
                }
              }
            }
          },
          "taskInfo": {
            "name": "evaluate-model"
          }
        },
        "ingest-data": {
          "cachingOptions": {
            "enableCache": true
          },
          "componentRef": {
            "name": "comp-ingest-data"
          },
          "inputs": {
            "parameters": {
              "project_id": {
                "componentInputParameter": "project_id"
              }
            }
          },
          "taskInfo": {
            "name": "ingest-data"
          }
        },
        "prepare-features": {
          "cachingOptions": {
            "enableCache": true
          },
          "componentRef": {
            "name": "comp-prepare-features"
          },
          "dependentTasks": [
            "ingest-data"
          ],
          "inputs": {
            "artifacts": {
              "input_data": {
                "taskOutputArtifact": {
                  "outputArtifactKey": "output_data",
                  "producerTask": "ingest-data"
                }
              }
            }
          },
          "taskInfo": {
            "name": "prepare-features"
          }
        },
        "train-model": {
          "cachingOptions": {
            "enableCache": true
          },
          "componentRef": {
            "name": "comp-train-model"
          },
          "dependentTasks": [
            "prepare-features"
          ],
          "inputs": {
            "artifacts": {
              "train_data": {
                "taskOutputArtifact": {
                  "outputArtifactKey": "train_data",
                  "producerTask": "prepare-features"
                }
              }
            }
          },
          "taskInfo": {
            "name": "train-model"
          }
        }
      }
    },
    "inputDefinitions": {
      "parameters": {
        "bucket_name": {
          "parameterType": "STRING"
        },
        "endpoint_name": {
          "defaultValue": "house-price-endpoint",
          "isOptional": true,
          "parameterType": "STRING"
        },
        "model_name": {
          "defaultValue": "house-price-model",
          "isOptional": true,
          "parameterType": "STRING"
        },
        "project_id": {
          "parameterType": "STRING"
        },
        "region": {
          "parameterType": "STRING"
        }
      }
    }
  },
  "schemaVersion": "2.1.0",
  "sdkVersion": "kfp-2.14.6"
}
